---
title: 分布式事务解决方案
date: 2024-04-29 13:34:12 +0800
categories: [企业架构设计]
tags: [架构设计]
---

> [注意] 所有的分布式事务方案，均无法100%保证成功（包括提交和回滚），应综合考虑人工介入处理的时效性和难度，对于现金交易等高敏感性业务不应采用分布式事务方案。条件允许的情况下，应该尽可能地使用单机事务，永远记住：Simple is the best！

## 现有解决方案对比
目前主流分布式事务方案都基于2PC、3PC、TCC、SAGA几种模型衍生，形态上有以下几种类型：

### 1. 数据库原生

以XA协议为代表的数据库原生方案，是实现了ACID特性的刚性事务。

优点：
- 业务的侵入性低

缺点：
- 全局加锁，并发性能差

### 2. 消息驱动方案

最大努力送达，适合用于“对数据库的操作最终一定能够成功”的场景。基于死信队列的最终一致性事务，适用于实时性要求较低的场景。

优点：
- 逻辑简单
- 性能损耗小

缺点：
- 适合的业务场景较少
- 脏读问题
- 与消息中间件耦合度高

### 3. 基于分布式锁方案

主要是基于TCC模式的开源框架
![alt text](/assets/img/20240429/image-7.png)

优点：
- 适合的业务场景较多
- 性能损耗较小
- 兼容必须使用XA的场景

缺点：
- 需要业务代码实现Try、Confirm、Cancel三个接口，代码入侵性强。
- 有空回滚、幂等、悬挂问题
- 开发成本大

### 4. 中间件

主要有Seata等分布式中间件，和Mycat等数据库代理中间件。

优点：
- 不同中间件不同
- 业务侵入性相对较小

缺点：
- 不同中间件不同
- 维护成本较高
- 有一定性能损耗

## KTech New Platform 方案选型

经过技术调研，结合银行业务场景，KTech New Platform最终选择集成Seata作为分布式事务解决方案，有以下几点原因：

### 1. 支持多种分布式事务协议

在实际生产环境中，不同的业务场景适合采用的分布式事务策略均有不同，Seata封装XA、TCC、SAGA模式及自研的AT模式，基本覆盖实际业务场景。采用Seata可有效降低自研复杂度和业务人员使用难度。

### 2. 开源且代码质量优秀

阅读Seata源码可知，Seata底层采用Netty实现tm、rm、tc间通信，从而实现全局事务开启、分支事务注册、提交、回滚和消息监听等功能，逻辑清晰结构简单；通过各种Handler、Listener、AOP实现了简便的API，开发使用难度低。

### 3. 性能满足基本需求

依据官方说明，Seata集群吞吐量可达10万次/秒。以目前行内架构数据库理论性能峰值（预估在3000QPS-6000QPS范围内）计算，Seata不会成为压力瓶颈，链路的TR增长也在可接受范围内。
> ![alt text](/assets/img/20240429/image-6.png)

### 4. 分布式中间件方案较合理

对比其他方案，分布式中间件在性能、可靠性、灵活性、使用难度等方面达到较好的平衡。

### 5. 中文社区活跃

Seata中文社区活跃度高，更适应国内开发风格和场景，后续升级迭代都有具备较好保障。

---- 
[1][分布式事务之解决方案（TCC）](https://cloud.tencent.com/developer/article/1547147)  
[2][如何选择分布式事务形态（TCC，SAGA，2PC，补偿，基于消息最终一致性等等）](https://www.cnblogs.com/skyesx/p/9697817.html)  
[3][深度解析MySQL分布式事务原理](https://zhuanlan.zhihu.com/p/129273442)  
[4][Seata：连接数据与应用](https://seata.apache.org/zh-cn/blog/seata-connect-data-and-application/)